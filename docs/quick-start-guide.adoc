= PasBuild Quick Start Guide
:toc: left
:toclevels: 3
// :toc-placement!:
:sectnums:
:source-highlighter: rouge
:icons: font

Complete guide to getting started with PasBuild.

// toc::[]

== Prerequisites

=== Free Pascal Compiler

PasBuild requires the Free Pascal Compiler (FPC) version 3.2.2 or later.

**Verify FPC Installation:**

[source,shell]
----
fpc -iV
----

This should output a version number like `3.2.2` or higher.

**FPC Must Be in PATH:**

PasBuild needs to find the `fpc` command. Verify it's in your PATH:

[source,shell]
----
which fpc        # Linux/macOS/FreeBSD
where fpc        # Windows
----

If FPC is not found:

* **Linux/FreeBSD**: Install via package manager (`apt install fpc`, `pkg install fpc`)
* **macOS**: Install via Homebrew (`brew install fpc`) or download from https://www.freepascal.org
* **Windows**: Download installer from https://www.freepascal.org and add to PATH

== Installing PasBuild

=== Option 1: Bootstrap from Source

**Clone the repository:**

[source,shell]
----
git clone https://github.com/yourusername/pasbuild.git
cd pasbuild
----

**Bootstrap compilation:**

Follow the instructions in link:../BOOTSTRAP.txt[BOOTSTRAP.txt]:

[source,shell]
----
# Linux/macOS/FreeBSD
mkdir -p target/units
fpc -Mobjfpc -O1 -FEtarget -FUtarget/units -Fusrc/main/pascal src/main/pascal/PasBuild.pas

# Verify build
./target/PasBuild --version
----

**Install to system (optional):**

[source,shell]
----
# Copy to /usr/local/bin (or ~/bin)
sudo cp target/PasBuild /usr/local/bin/pasbuild
----

=== Option 2: Pre-built Binary

Download the latest release from GitHub Releases and extract to your PATH.

== Project Types

PasBuild supports two types of projects:

1. **Application Projects** - Executable programs with a main entry point
2. **Library Projects** - Frameworks/libraries consisting only of units (no executable)

=== Application vs Library

[cols="1,2,2"]
|===
|Aspect |Application |Library

|Main Source
|Required: must be `program` unit
|Optional: auto-generated bootstrap program

|Compilation Output
|Executable binary
|Compiled units (.ppu files)

|Package Contents
|Executable + LICENSE + README
|Source code or compiled units

|Bootstrap Program
|Not needed
|Auto-generated in target/
|===

== Creating Your First Project

=== Using `pasbuild init`

The fastest way to start a new project:

[source,shell]
----
mkdir myapp
cd myapp
pasbuild init
----

**Interactive Prompts:**

[source]
----
Project type (application/library) [application]:
Project name [myapp]: MyApplication
Version [1.0.0]:
Author [yourusername]: Your Name
License (MIT/BSD-3-Clause/GPL-3.0/Apache-2.0/Proprietary) [MIT]: BSD-3-Clause
----

Press ENTER to accept defaults shown in square brackets.

**Generated Structure (Application):**

[source]
----
myapp/
├── project.xml
├── LICENSE
└── src/
    └── main/
        └── pascal/
            └── Main.pas
----

**Generated Structure (Library):**

[source]
----
mylib/
├── project.xml
├── LICENSE
└── src/
    └── main/
        └── pascal/
            (empty - add your library units here)
----

=== Manual Project Setup

If you prefer to create files manually:

**1. Create directory structure:**

[source,shell]
----
mkdir -p myapp/src/main/pascal
cd myapp
----

**2. Create `project.xml`:**

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<project>
  <name>MyApplication</name>
  <version>1.0.0</version>
  <author>Your Name</author>
  <license>BSD-3-Clause</license>

  <build>
    <mainSource>Main.pas</mainSource>
    <executableName>myapp</executableName>
    <outputDirectory>target</outputDirectory>
  </build>
</project>
----

**3. Create `src/main/pascal/Main.pas`:**

[source,pascal]
----
program Main;

{$mode objfpc}{$H+}

uses
  SysUtils;

begin
  WriteLn('Hello from MyApplication!');
end.
----

=== Creating a Library Project

Library projects (frameworks, toolkits) don't have a main program. PasBuild automatically generates a bootstrap program to compile all units.

**1. Create `project.xml` for a library:**

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<project>
  <name>MyLibrary</name>
  <version>1.0.0</version>
  <author>Your Name</author>
  <license>BSD-3-Clause</license>

  <build>
    <projectType>library</projectType>
    <outputDirectory>target</outputDirectory>
  </build>
</project>
----

**2. Add your library units:**

[source]
----
src/main/pascal/
├── MyLib.Core.pas
├── MyLib.Utils.pas
└── MyLib.Types.pas
----

**3. Compile:**

[source,shell]
----
pasbuild compile
----

PasBuild will:

1. Auto-discover all .pas files
2. Generate `target/bootstrap_program.pas` with all units in uses clause
3. Compile the bootstrap to verify all units compile successfully

== Building Your Project

=== Basic Compilation

Compile your project:

[source,shell]
----
pasbuild compile
----

**Output:**

[source]
----
[INFO] PasBuild 1.0.0

[INFO] Executing goal: compile
[INFO] Compiling project...
[INFO] Build command: fpc -Mobjfpc -O1 src/main/pascal/Main.pas -FEtarget ...

Free Pascal Compiler version 3.2.2 ...
Compiling src/main/pascal/Main.pas
Linking target/myapp
12 lines compiled, 0.1 sec

[INFO] Build successful
----

**Run your program:**

[source,shell]
----
./target/myapp          # Linux/macOS/FreeBSD
target\myapp.exe        # Windows
----

=== Using Build Profiles

Build profiles allow different compiler settings without code changes.

**Add profiles to `project.xml`:**

[source,xml]
----
<profiles>
  <profile>
    <id>debug</id>
    <defines>
      <define>DEBUG</define>
    </defines>
    <compilerOptions>
      <option>-g</option>        <!-- Debug symbols -->
      <option>-gl</option>       <!-- Line info -->
      <option>-Criot</option>    <!-- Range/overflow/I/O checks -->
      <option>-gh</option>       <!-- Heap trace -->
    </compilerOptions>
  </profile>

  <profile>
    <id>release</id>
    <defines>
      <define>RELEASE</define>
    </defines>
    <compilerOptions>
      <option>-O3</option>       <!-- Maximum optimization -->
      <option>-CX</option>       <!-- Smart linking -->
      <option>-XX</option>       <!-- Strip symbols -->
    </compilerOptions>
  </profile>
</profiles>
----

**Build with profile:**

[source,shell]
----
pasbuild compile -p debug      # Debug build
pasbuild compile -p release    # Release build
----

=== Using Conditional Compilation

In your Pascal code:

[source,pascal]
----
{$IFDEF DEBUG}
  WriteLn('Debug mode enabled');
  WriteLn('Starting application...');
{$ENDIF}

{$IFDEF RELEASE}
  // Release-specific code
{$ENDIF}
----

== Advanced Features

=== Platform-Specific Code with Conditional Paths

For cross-platform projects with platform-specific directories, use conditional unit paths.

**Example: Cross-Platform GUI Library**

[source]
----
src/main/pascal/
├── core/
│   ├── MyLib.Base.pas       ← Always included
│   ├── MyLib.Common.pas     ← Always included
│   ├── x11/                 ← Linux/FreeBSD only
│   │   └── MyLib.X11.pas
│   ├── gdi/                 ← Windows only
│   │   └── MyLib.GDI.pas
│   └── cocoa/               ← macOS only
│       └── MyLib.Cocoa.pas
----

**Configure conditional paths in `project.xml`:**

[source,xml]
----
<build>
  <projectType>library</projectType>
  <outputDirectory>target</outputDirectory>

  <unitPaths>
    <!-- Only specify platform-specific paths -->
    <!-- PasBuild auto-scans everything else -->
    <path condition="UNIX">core/x11</path>
    <path condition="WINDOWS">core/gdi</path>
    <path condition="DARWIN">core/cocoa</path>
  </unitPaths>
</build>
----

**How it works:**

1. PasBuild auto-scans all directories (core/, etc.)
2. For conditional paths:
   - On Linux: includes `core/x11/`, excludes `core/gdi/` and `core/cocoa/`
   - On Windows: includes `core/gdi/`, excludes `core/x11/` and `core/cocoa/`
   - On macOS: includes `core/cocoa/`, excludes `core/x11/` and `core/gdi/`
3. Non-conditional directories always included

**Supported platform conditions:**

* `UNIX` - All Unix-like systems (Linux, FreeBSD, macOS)
* `LINUX` - Linux specifically
* `FREEBSD` - FreeBSD specifically
* `DARWIN` - macOS / iOS
* `WINDOWS` - All Windows versions
* `WIN32` - 32-bit Windows
* `WIN64` - 64-bit Windows
* Custom defines from `<defines>` or profiles

**Include files (*.inc):**

PasBuild automatically detects directories containing `*.inc` files and adds them as include paths (`-Fi`). The same conditional filtering applies - if a platform-specific directory contains `.inc` files, it's only added as an include path when that platform's condition is met.

=== Manual Unit Path Control

By default, PasBuild auto-scans all subdirectories. For explicit control, use manual mode:

[source,xml]
----
<build>
  <manualUnitPaths>true</manualUnitPaths>

  <unitPaths>
    <!-- Must list ALL paths explicitly -->
    <path>core</path>
    <path>gui</path>
    <path>utils</path>
    <!-- Platform-specific paths still support conditions -->
    <path condition="UNIX">core/x11</path>
    <path condition="WINDOWS">core/gdi</path>
  </unitPaths>
</build>
----

**When to use manual mode:**

* Large projects where auto-scan is slow
* Need explicit control over compilation order
* Want to exclude certain directories from compilation

**Note:** Manual mode still respects conditional filtering for listed paths.

== Available Goals

=== clean

Removes all build artifacts.

[source,shell]
----
pasbuild clean
----

Deletes the `target/` directory and all its contents.

=== compile

Compiles the project.

[source,shell]
----
pasbuild compile              # Default build
pasbuild compile -p debug     # With debug profile
pasbuild compile -p release   # With release profile
----

**What it does:**

1. Verifies directory layout
2. Checks if FPC is available
3. Scans for unit paths
4. Creates output directories
5. Builds FPC command with all flags
6. Executes FPC with real-time output

**Generated compiler flags:**

* `-Mobjfpc` - Object Pascal mode
* `-O1` - Basic optimization (default)
* `-FEtarget` - Executable output directory
* `-FUtarget/units` - Unit output directory
* `-Fusrc/main/pascal` - Unit search path (auto-scanned)
* `-d<define>` - Global and profile defines
* Profile compiler options override defaults

=== package

Creates a release archive.

[source,shell]
----
pasbuild package
----

**Dependencies:** Automatically runs `clean` → `compile` → `package`

**What it creates:**

A ZIP archive at `target/<name>-<version>.zip` containing:

* Compiled executable
* `LICENSE` file (if exists)
* `README` file (if exists - checks .md, .adoc, .txt, .rst)

**Example:**

[source,shell]
----
pasbuild package

# Creates: target/myapp-1.0.0.zip
# Contains:
#   myapp (or myapp.exe on Windows)
#   LICENSE
#   README.md
----

=== init

Bootstraps a new project.

[source,shell]
----
pasbuild init
----

**Interactive prompts** for:

* Project type (default: application)
* Project name (default: current directory name)
* Version (default: 1.0.0)
* Author (default: $USER or $USERNAME)
* License (default: MIT)

**What it creates:**

* `project.xml` - Project configuration with appropriate projectType
* `src/main/pascal/Main.pas` - Hello World template (application only)
* `LICENSE` - Full license text (MIT, BSD-3-Clause, or Proprietary)

**Project type behavior:**

* **Application**: Creates Main.pas, includes mainSource and executableName in XML
* **Library**: No Main.pas created, minimal XML (bootstrap auto-generated at compile time)

**Error handling:**

If `project.xml` already exists, returns error: `"Project already initialized"`

== Configuration Reference

=== Minimal Configuration

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<project>
  <name>MyApp</name>
  <version>1.0.0</version>
  <author>Your Name</author>
  <license>BSD-3-Clause</license>

  <build>
    <mainSource>Main.pas</mainSource>
    <executableName>myapp</executableName>
  </build>
</project>
----

=== Full Configuration (Application)

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<project>
  <!-- Project Metadata -->
  <name>MyApplication</name>
  <version>2.1.0</version>
  <author>Your Name</author>
  <license>BSD-3-Clause</license>

  <!-- Build Configuration -->
  <build>
    <!-- Project type (application or library, default: application) -->
    <projectType>application</projectType>

    <!-- Main source file in src/main/pascal/ -->
    <mainSource>Main.pas</mainSource>

    <!-- Executable name (without platform extension) -->
    <executableName>myapp</executableName>

    <!-- Output directory (default: target) -->
    <outputDirectory>target</outputDirectory>

    <!-- Global defines (available in all builds) -->
    <defines>
      <define>UseCThreads</define>
      <define>MYAPP_FEATURE_X</define>
    </defines>

    <!-- Conditional unit paths (platform-specific directories) -->
    <!-- Include paths (*.inc) are auto-detected with same filtering -->
    <unitPaths>
      <path condition="UNIX">platform/x11</path>
      <path condition="WINDOWS">platform/gdi</path>
      <path condition="DARWIN">platform/cocoa</path>
    </unitPaths>
  </build>

  <!-- Build Profiles -->
  <profiles>
    <profile>
      <id>debug</id>
      <defines>
        <define>DEBUG</define>
        <define>VERBOSE_LOGGING</define>
      </defines>
      <compilerOptions>
        <option>-g</option>        <!-- Debug info -->
        <option>-gl</option>       <!-- Line info -->
        <option>-Criot</option>    <!-- Runtime checks -->
        <option>-gh</option>       <!-- Heap trace -->
      </compilerOptions>
    </profile>

    <profile>
      <id>release</id>
      <defines>
        <define>RELEASE</define>
      </defines>
      <compilerOptions>
        <option>-O3</option>       <!-- Max optimization -->
        <option>-CX</option>       <!-- Smart linking -->
        <option>-XX</option>       <!-- Strip symbols -->
        <option>-Xs</option>       <!-- Strip all -->
      </compilerOptions>
    </profile>
  </profiles>
</project>
----

=== Full Configuration (Library)

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<project>
  <!-- Project Metadata -->
  <name>MyLibrary</name>
  <version>1.0.0</version>
  <author>Your Name</author>
  <license>BSD-3-Clause</license>

  <!-- Build Configuration -->
  <build>
    <!-- Library project - no mainSource needed -->
    <projectType>library</projectType>
    <outputDirectory>target</outputDirectory>

    <!-- Global defines -->
    <defines>
      <define>UseCThreads</define>
    </defines>

    <!-- Platform-specific unit paths -->
    <!-- Bootstrap program auto-generated with all discovered units -->
    <unitPaths>
      <path condition="UNIX">corelib/x11</path>
      <path condition="WINDOWS">corelib/gdi</path>
      <path condition="DARWIN">corelib/cocoa</path>
    </unitPaths>
  </build>

  <!-- Build Profiles -->
  <profiles>
    <profile>
      <id>debug</id>
      <defines>
        <define>DEBUG</define>
      </defines>
      <compilerOptions>
        <option>-g</option>
        <option>-gl</option>
      </compilerOptions>
    </profile>

    <profile>
      <id>release</id>
      <defines>
        <define>RELEASE</define>
      </defines>
      <compilerOptions>
        <option>-O3</option>
        <option>-CX</option>
      </compilerOptions>
    </profile>
  </profiles>
</project>
----

== Command-Line Reference

=== Goals

[source,shell]
----
pasbuild clean                    # Remove build artifacts
pasbuild compile                  # Compile project
pasbuild compile -p <profile>     # Compile with profile
pasbuild package                  # Create release archive
pasbuild init                     # Bootstrap new project
----

=== Options

[source,shell]
----
-p <profile-id>                   # Activate build profile
--profile <profile-id>            # Activate build profile (long form)
-h, --help                        # Show help message
-v, --version                     # Show version information
----

=== Examples

[source,shell]
----
# Clean build with debug profile
pasbuild clean
pasbuild compile -p debug

# Release build and package
pasbuild compile -p release
pasbuild package

# Get help
pasbuild --help
pasbuild compile --help
----

== Directory Layout

PasBuild follows Maven's Standard Directory Layout:

[source]
----
project-root/
├── project.xml              # Project configuration
├── LICENSE                  # License file
├── README.md               # Project documentation
├── BOOTSTRAP.txt           # Bootstrap instructions (optional)
│
├── src/
│   └── main/
│       └── pascal/         # Application source files
│           ├── Main.pas
│           ├── Unit1.pas
│           └── subdir/     # Subdirectories auto-scanned
│               └── Unit2.pas
│
└── target/                 # Build output (auto-created)
    ├── myapp               # Executable
    ├── myapp-1.0.0.zip    # Package archive
    └── units/             # Compiled units
        ├── Unit1.ppu
        ├── Unit1.o
        └── ...
----

**Key Points:**

* Source files go in `src/main/pascal/`
* Build output goes in `target/`
* `target/` is auto-created and cleaned
* Subdirectories are automatically scanned for units

== Troubleshooting

=== FPC not found

**Error:** `"Free Pascal Compiler (fpc) not found in PATH"`

**Solution:**

1. Verify FPC is installed: `fpc -iV`
2. Add FPC to PATH
3. Restart terminal

=== Main source file not found

**Error:** `"Main source file not found: src/main/pascal/Main.pas"`

**Solution:**

1. Check file exists in correct location
2. Verify `<mainSource>` in `project.xml` matches filename
3. File must be in `src/main/pascal/` directory

=== Project already initialized

**Error:** `"Project already initialized (project.xml exists)"`

**Solution:**

* Delete `project.xml` if you want to re-initialize
* Or manually edit the existing `project.xml`

=== Unit not found errors

**Error:** `"Fatal: Can't find unit MyUnit used by Main"`

**Solution:**

1. Ensure unit file exists in `src/main/pascal/` or subdirectory
2. PasBuild automatically scans subdirectories for units
3. Check unit filename matches unit name in `uses` clause

=== Permission denied on executable

**Error:** Permission denied when running `./target/myapp`

**Solution:**

[source,shell]
----
chmod +x target/myapp
----

(PasBuild should set this automatically on Unix systems)

== Next Steps

* Read link:design.adoc[Design Document] for architecture details
* Check link:implementation-progress.adoc[Implementation Progress] for feature roadmap
* Join the community and contribute!

== Getting Help

* GitHub Issues: Report bugs and request features
* Documentation: link:../README.adoc[README] | link:design.adoc[Design] | link:implementation-progress.adoc[Progress]
* FPC Documentation: https://www.freepascal.org/docs.html

= PasBuild Implementation Progress
:toc: left
:toclevels: 3
:sectnums:
:source-highlighter: rouge
:icons: font

== Overview

This document tracks the implementation progress of PasBuild. All phases and tasks must be updated as work progresses.

**Status Legend:**

* ‚¨ú Not Started
* üîÑ In Progress
* ‚úÖ Completed
* ‚è∏Ô∏è Blocked / Deferred

**Last Updated:** 2025-12-06

**Current Phase:** Phase 2 - Goal Implementation (2.1 ‚úÖ | 2.2 ‚úÖ | Working on 2.3)


== Phase 0: Project Bootstrap ‚úÖ

**Goal:** Create basic project structure and tooling

**Status:** COMPLETED 2025-12-06

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Create PasBuild project directory structure
|Created `src/main/pascal/`

|‚úÖ
|Create initial `project.xml` for PasBuild itself
|Self-hosting config with debug/release profiles

|‚úÖ
|Create `src/main/pascal/PasBuild.pas` entry point
|Basic skeleton with --help and --version

|‚úÖ
|Setup `.gitignore` (exclude `target/`, `*.o`, `*.ppu`, etc.)
|Comprehensive ignore rules added

|‚úÖ
|Create `docs/` directory structure
|Contains design.adoc and implementation-progress.adoc
|===

**Deliverables:**

* ‚úÖ Standard directory layout (`src/main/pascal/`)
* ‚úÖ Self-documenting `project.xml` with profiles
* ‚úÖ Minimal working program (shows help/version)
* ‚úÖ Clean `.gitignore` for Pascal projects
* ‚úÖ Design and progress documentation


== Phase 1: Core Infrastructure

**Goal:** Foundation for all goals - config loading, validation, and CLI parsing

=== 1.1 Data Structures ‚úÖ

**Status:** COMPLETED 2025-12-06

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Create `PasBuild.Types` unit
|Using FGL generics for type safety

|‚úÖ
|Define `TProjectConfig` record/class
|Holds all project.xml data

|‚úÖ
|Define `TBuildConfig` record/class
|Nested under TProjectConfig

|‚úÖ
|Define `TProfile` record/class
|Profile data structure with defines + compiler options

|‚úÖ
|Define `TProfileList` collection type
|Generic TFPGObjectList<TProfile> with FindById
|===

**Deliverable:** Complete type hierarchy for configuration

**Implementation Notes:**

* Used `fgl` unit (Free Pascal Generics Library) for type-safe collections
* `TProfileList = specialize TFPGObjectList<TProfile>` provides compile-time type safety
* `FindById` method uses `for..in` iterator (cleaner than indexed loop)
* All string lists use `Duplicates := dupIgnore` to prevent duplicate defines
* Default values set in constructors: `OutputDirectory := 'target'`, `Author := 'Unknown'`, `License := 'Proprietary'`
* Unit compiles cleanly with FPC 3.2.2

---

=== 1.2 Configuration Loader ‚úÖ

**Status:** COMPLETED 2025-12-06

**File:** `src/main/pascal/PasBuild.Config.pas`

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Implement `LoadProjectXML(FilePath: string): TProjectConfig`
|Complete with error handling

|‚úÖ
|Parse required fields: `name`, `version`
|Raises EProjectConfigError if missing

|‚úÖ
|Parse optional fields with defaults
|`author`, `license`, `projectUrl`, `repoUrl`

|‚úÖ
|Parse `<build>` section
|All fields including validation

|‚úÖ
|Parse `<build><defines>` list
|Global defines parsed correctly

|‚úÖ
|Parse `<profiles>` section
|Into TProfileList with proper ownership

|‚úÖ
|Parse profile `<compilerOptions>` section
|Per-profile compiler flags working

|‚úÖ
|Implement `ValidateConfig(Config: TProjectConfig): Boolean`
|Full semantic validation

|‚úÖ
|Implement semantic versioning validation
|Regex: `^\d+\.\d+\.\d+$` implemented

|‚úÖ
|Add error handling for malformed XML
|Try/except with EProjectConfigError

|‚è∏Ô∏è
|Write unit tests for ConfigLoader
|Deferred - manual testing complete
|===

**Deliverable:** Fully functional XML parser with validation

**Implementation Notes:**

* Custom exception type: `EProjectConfigError` for clear error messages
* Helper methods for clean code organization:
  - `GetNodeText`: Safe node value extraction with defaults
  - `ParseDefines`: Iterates `<define>` children
  - `ParseCompilerOptions`: Iterates `<option>` children
  - `ParseBuildSection`: Handles entire `<build>` section
  - `ParseProfile`: Handles individual profile parsing
  - `ParseProfiles`: Iterates all profiles
* Validation includes:
  - Semantic version format (MAJOR.MINOR.PATCH)
  - Project name (alphanumeric, hyphens, underscores only)
  - Main source file extension (.pas, .pp, .lpr)
* Uses RegExpr unit for pattern matching
* Tested successfully with project.xml (all profiles and defines parsed correctly)
* Clean exception handling - frees TProjectConfig on error

---

=== 1.3 CLI Argument Parser ‚úÖ

**Status:** COMPLETED 2025-12-06

**File:** `src/main/pascal/PasBuild.CLI.pas`

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Implement `ParseArguments(): TCommandLineArgs`
|Returns structured record with all parsed data

|‚úÖ
|Support goals: `clean`, `compile`, `package`, `init`
|Case-insensitive matching with TBuildGoal enum

|‚úÖ
|Support `-p <profile-id>` flag parsing
|Also supports `--profile` long form

|‚úÖ
|Support `--help` flag
|Display usage instructions (also `-h`)

|‚úÖ
|Support `--version` flag
|Show PasBuild version (also `-v`)

|‚úÖ
|Implement error handling for unknown goals
|Sets ErrorMessage and ShowHelp flag

|‚úÖ
|Implement error handling for invalid arguments
|E.g., `-p` without profile ID returns clear error
|===

**Deliverable:** Robust argument parser with help system

**Implementation Notes:**

* Type-safe goal handling using `TBuildGoal` enum instead of strings
* Structured return type `TCommandLineArgs` record contains:
  - `Goal`: TBuildGoal enum value
  - `ProfileId`: string (empty if no profile specified)
  - `ShowHelp`: Boolean flag
  - `ShowVersion`: Boolean flag
  - `ErrorMessage`: string (empty if no error)
* Case-insensitive goal matching (clean, CLEAN, Clean all work)
* Both short and long forms supported: `-p` and `--profile`, `-h` and `--help`
* Clean separation of concerns: parsing vs. help display vs. version display
* Error messages guide user toward correct usage
* All edge cases tested:
  - No arguments ‚Üí shows help with error
  - Unknown goal ‚Üí shows help with error
  - Missing profile ID after -p ‚Üí clear error
  - Valid goals with/without profile ‚Üí success

---

=== 1.4 Utility Functions ‚úÖ

**Status:** COMPLETED 2025-12-06

**File:** `src/main/pascal/PasBuild.Utils.pas`

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Implement `NormalizePath(Path: string): string`
|Cross-platform path normalization (/ ‚Üí platform separator)

|‚úÖ
|Implement `VerifyDirectoryLayout(ProjectRoot: string): Boolean`
|Check if `src/main/pascal/` exists

|‚úÖ
|Implement `ScanForUnitPaths(BaseDir: string): TStringList`
|Recursive directory scan for `-Fu` with exclusions

|‚úÖ
|Implement `ExecuteProcess(Command: string; ShowOutput: Boolean): Integer`
|Real-time output streaming via TProcess

|‚úÖ
|Implement `ExecuteProcessWithCapture(Command: string; out Output: string): Integer`
|Capture output to string

|‚úÖ
|Implement `DetectFPCVersion(): string`
|Run `fpc -iV`, parse output

|‚úÖ
|Implement `IsFPCAvailable: Boolean`
|Check if FPC exists in PATH

|‚úÖ
|Implement `GetPlatformExecutableSuffix(): string`
|Return `.exe` on Windows, empty on Unix

|‚úÖ
|Add logging helpers: `LogInfo`, `LogError`, `LogWarning`
|Formatted output with stderr for errors
|===

**Deliverable:** Reusable utilities for file/process operations

**Implementation Notes:**

* **NormalizePath**: Converts `/` to platform-specific separator (Maven convention)
  - Allows `project.xml` to use Unix-style paths everywhere
  - Automatically works on Windows and Unix
* **ScanForUnitPaths**: Recursive directory scanner with exclusions
  - Skips: `.`, `..`, `.git`, `.svn`, `backup*`
  - Returns sorted, unique path list
  - Used to generate `-Fu` flags for FPC
* **Process Execution**: Two modes
  - `ExecuteProcess`: Real-time output streaming (for compilation)
  - `ExecuteProcessWithCapture`: Capture to string (for version detection)
  - Uses `/bin/sh -c` on Unix, `cmd.exe /c` on Windows
  - Proper error handling with try/except
* **FPC Detection**: Uses `fpc -iV` (short version) instead of deprecated `-version`
* **Logging**: Three severity levels
  - `LogInfo`: Stdout with `[INFO]` prefix
  - `LogWarning`: Stdout with `[WARNING]` prefix
  - `LogError`: Stderr with `[ERROR]` prefix
* **No memory leaks**: Verified with heap trace (`-gh`)

**Cross-Platform Design:**

Maven-inspired path handling: Users write paths with `/` in `project.xml`, and `NormalizePath` converts them to the correct separator for the current platform. This ensures project files work identically on Windows, Linux, and macOS.


== Phase 2: Goal Implementation

=== 2.1 Clean Goal ‚úÖ

**Status:** COMPLETED 2025-12-06

**Files:** `src/main/pascal/PasBuild.Command.pas`, `PasBuild.Command.Clean.pas`

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Design Command Pattern architecture
|TBuildCommand base class + TCommandExecutor

|‚úÖ
|Implement dependency resolution in executor
|Automatic execution of goal dependencies

|‚úÖ
|Implement `TCleanCommand.Execute`
|Main clean logic

|‚úÖ
|Check if output directory exists
|Graceful handling of non-existent directory

|‚úÖ
|Implement safe recursive delete
|Custom implementation, no external dependencies

|‚úÖ
|Add safety check: only delete configured output directory
|Prevents deleting project root or external paths

|‚úÖ
|Log actions: "Cleaning <directory>..."
|Clear user feedback

|‚úÖ
|Return exit code 0 on success
|Proper exit codes

|‚úÖ
|Handle errors gracefully (permissions, locked files)
|Try/except with clear error messages

|‚úÖ
|Memory leak verification
|Tested with -gh, zero leaks
|===

**Deliverable:** Functional `pasbuild clean` command with Command Pattern

**Implementation Notes:**

* **Command Pattern Architecture**:
  - `TBuildCommand`: Abstract base class for all goals
  - `TCommandExecutor`: Orchestrates command execution with dependency resolution
  - `TBuildCommandList`: Generic list of commands
  - Each goal extends `TBuildCommand` and implements `Execute` method
  - Dependencies declared via `GetDependencies` method
  - Executor tracks executed commands to prevent duplicates

* **Clean Command Features**:
  - Deletes configured output directory (normalized for cross-platform)
  - Safety checks:
    * Only deletes if directory is under project root
    * Won't delete project root itself
    * Won't delete external directories
  - Gracefully handles already-clean state
  - Custom recursive delete using `FindFirst`/`FindNext`
  - No dependency on Lazarus FileUtil

* **Testing**:
  - `PasBuild.Test.Clean`: Tests clean command in isolation
  - `PasBuild.Test.Command`: Tests command pattern with duplicates
  - All tests verified with heap trace (-gh flag)
  - Zero memory leaks detected

**Design Benefits:**

The Command Pattern provides:
1. Clean separation of concerns (each goal is independent)
2. Automatic dependency resolution (package will auto-run clean ‚Üí compile)
3. Duplicate prevention (same goal won't run twice)
4. Easy extensibility (new goals just extend TBuildCommand)
5. Testability (commands can be tested in isolation)

---

=== 2.2 Compile Goal ‚úÖ

**Status:** COMPLETED 2025-12-06

**File:** `src/main/pascal/PasBuild.Command.Compile.pas`

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Implement `TCompileCommand.Execute`
|Main entry point with full validation

|‚úÖ
|Validate `src/main/pascal/` exists
|Via TUtils.VerifyDirectoryLayout

|‚úÖ
|Validate `mainSource` file exists
|Full path check with clear error

|‚úÖ
|Create `target/` directory if missing
|Use `ForceDirectories`

|‚úÖ
|Create `target/units/` directory
|For `-FU` output

|‚úÖ
|Scan for unit paths (`-Fu`)
|TUtils.ScanForUnitPaths with recursion

|‚úÖ
|Construct base FPC command
|`fpc -Mobjfpc -O1`

|‚úÖ
|Add `-FE` and `-FU` flags
|Output directories with normalized paths

|‚úÖ
|Add `-o` flag for executable name
|Include platform suffix via TUtils

|‚úÖ
|Add global defines (`-d<name>`)
|From `<build><defines>`

|‚úÖ
|Load active profile if specified
|Lookup by ProfileID with validation

|‚úÖ
|Add profile defines (`-d<name>`)
|Merged with global defines

|‚úÖ
|Add profile compiler options
|Appended after defaults (can override)

|‚úÖ
|Execute FPC command via TProcess
|TUtils.ExecuteProcess with real-time output

|‚úÖ
|Stream compiler output to console
|Real-time display during compilation

|‚úÖ
|Return FPC's exit code
|0 = success, propagate FPC errors

|‚úÖ
|Handle FPC not found error
|TUtils.IsFPCAvailable check before execution

|‚úÖ
|Memory leak verification
|Tested with -gh, zero leaks
|===

**Deliverable:** Functional `pasbuild compile` with profile support

**Implementation Notes:**

* **Command Construction** (`BuildCompilerCommand`):
  - Base flags: `-Mobjfpc -O1` (Object Pascal mode, level 1 optimization)
  - Source path: Normalized for cross-platform
  - Output flags: `-FE<dir>` (executable), `-FU<dir>` (units)
  - Executable name: `-o<name>` with platform suffix (.exe on Windows)
  - Unit paths: Automatically scanned from subdirectories
  - Global defines: All `-d` flags from config
  - Profile defines: Additional `-d` flags from active profile
  - Profile options: Can override optimization level and add debugging

* **Validation Flow**:
  1. Check directory layout (src/main/pascal exists)
  2. Verify main source file exists
  3. Check FPC availability in PATH
  4. Create output directories
  5. Build command string
  6. Execute with real-time output
  7. Report success/failure

* **Profile Support**:
  - Profile lookup by ID
  - Warning if profile not found (continues without it)
  - Profile defines merged with globals
  - Profile compiler options appended (later flags override earlier ones)
  - Example debug profile: `-g -gl` for debugging symbols
  - Example release profile: `-O3 -CX -XX` for optimization + smart linking

* **Testing**:
  - Successfully compiled PasBuild itself
  - Tested without profile (default build)
  - Tested with debug profile (adds debugging flags)
  - Verified compiled binary executes correctly
  - Zero memory leaks confirmed with heap trace

**Example Generated Commands:**

Default build:
```bash
fpc -Mobjfpc -O1 src/main/pascal/PasBuild.pas -FEtarget -FUtarget/units -opasbuild -dUseCThreads
```

Debug profile:
```bash
fpc -Mobjfpc -O1 src/main/pascal/PasBuild.pas -FEtarget -FUtarget/units -opasbuild -dUseCThreads -dDEBUG -g -gl
```

Release profile:
```bash
fpc -Mobjfpc -O1 src/main/pascal/PasBuild.pas -FEtarget -FUtarget/units -opasbuild -dUseCThreads -dRELEASE -O3 -CX -XX
```
(Note: `-O3` overrides earlier `-O1`)

---

=== 2.2.1 Main Program Integration ‚úÖ

**Status:** COMPLETED 2025-12-06

**File:** `src/main/pascal/PasBuild.pas` (updated)

**Overview:**

Integrated the Command Pattern goals into the main PasBuild program, enabling full self-hosting capability.

**Changes:**

* Wired `TCleanCommand` and `TCompileCommand` into main program flow
* Added `TCommandExecutor` to handle command execution
* Proper error handling and exit code propagation
* Memory cleanup with try/finally blocks
* All goals now executable via command line

**Main Execution Flow:**

```pascal
// 1. Parse command line arguments
Args := TArgumentParser.ParseArguments;

// 2. Handle --help and --version
if Args.ShowHelp then ...
if Args.ShowVersion then ...

// 3. Load project configuration
Config := TConfigLoader.LoadProjectXML('project.xml');

// 4. Create command executor
Executor := TCommandExecutor.Create;

// 5. Create appropriate command based on goal
case Args.Goal of
  bgClean: Command := TCleanCommand.Create(Config, Args.ProfileId);
  bgCompile: Command := TCompileCommand.Create(Config, Args.ProfileId);
  bgPackage: [not yet implemented]
  bgInit: [not yet implemented]
end;

// 6. Execute command with dependency resolution
ExitCode := Executor.Execute(Command);
```

**Bootstrap Documentation:**

Created `BOOTSTRAP.txt` with cross-platform manual compilation instructions for:
* Linux
* macOS
* FreeBSD
* Windows

The bootstrap process requires only FPC and two simple commands:
1. `mkdir -p target/units`
2. `fpc -Mobjfpc -O1 -FEtarget -FUtarget/units -Fusrc/main/pascal src/main/pascal/PasBuild.pas`

**Self-Hosting Verification:**

Successfully tested the following workflow:

```bash
# Bootstrap compile
mkdir -p target/units
fpc -Mobjfpc -O1 -FEtarget -FUtarget/units -Fusrc/main/pascal src/main/pascal/PasBuild.pas

# Test clean command
./target/PasBuild clean

# Rebuild using PasBuild itself (self-hosting!)
mkdir -p target/units
fpc -Mobjfpc -O1 -FEtarget -FUtarget/units -Fusrc/main/pascal src/main/pascal/PasBuild.pas
./target/PasBuild compile

# Test with profile
./target/PasBuild compile -p debug
```

**Deliverable:** PasBuild can now compile itself - full self-hosting achieved!

**Implementation Notes:**

* **Self-Hosting Achievement**: PasBuild successfully compiles itself using the compile command
* **Memory Management**: All resources properly freed in finally blocks
* **Exit Codes**: Proper propagation from commands to main program
* **Error Handling**: Clean error messages with appropriate exit codes
* **Profile Support**: Works with both default and profile-specific builds
* **Cross-Platform**: Bootstrap instructions for all major platforms

---

=== 2.3 Package Goal ‚úÖ

**Status:** COMPLETED 2025-12-06

**File:** `src/main/pascal/PasBuild.Command.Package.pas`

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Implement `TPackageCommand.Execute`
|Main entry point with error handling

|‚úÖ
|Declare dependencies: clean ‚Üí compile
|Via GetDependencies override

|‚úÖ
|Command executor runs dependencies
|Automatic via Command Pattern

|‚úÖ
|Verify executable exists
|Full path check in CreateArchive

|‚úÖ
|Create archive filename: `target/<name>-<version>.zip`
|Following Maven convention

|‚úÖ
|Initialize TZipper from FPC's zipper unit
|Cross-platform ZIP support

|‚úÖ
|Add executable to archive
|Flat structure (no directories)

|‚úÖ
|Add LICENSE file if exists
|With file extension variants

|‚úÖ
|Add README file if exists
|With file extension variants (.md, .adoc, .txt, .rst)

|‚úÖ
|Exclude intermediate files (*.o, *.ppu)
|Only executable included from target/

|‚úÖ
|Save archive to target/ directory
|Maven convention: all artifacts in target/

|‚úÖ
|Log success with archive path
|Clear user feedback

|‚úÖ
|Return exit code 0 on success
|Proper error propagation
|===

**Deliverable:** Functional `pasbuild package` command with cross-platform ZIP creation

**Implementation Notes:**

* **Command Pattern Integration**:
  - TPackageCommand extends TBuildCommand
  - Declares dependencies: clean ‚Üí compile
  - Executor runs dependencies automatically before package

* **Archive Creation** (using FPC's `zipper` unit):
  - Cross-platform ZIP creation without external tools
  - Archive name: `target/<name>-<version>.zip`
  - Flat structure (files at root, no nested directories)
  - Following Maven convention: all build artifacts in target/

* **File Discovery** (`FindFileWithVariants` helper):
  - Generic helper function to find files with common extensions
  - Searches for: `<basename>`, `<basename>.txt`, `.md`, `.adoc`, `.rst`
  - Handles LICENSE and COPYING as base names
  - Handles README with various extensions

* **Archive Contents**:
  - **Always included**: Compiled executable
  - **Optional**: LICENSE (or LICENSE.txt, LICENSE.md, LICENSE.adoc, COPYING, etc.)
  - **Optional**: README (or README.md, README.adoc, README.txt, README.rst)
  - **Excluded**: Intermediate build artifacts (.o, .ppu files)

* **Maven Convention Compliance**:
  - Archive saved to `target/` directory (not project root)
  - Cleaned automatically by `pasbuild clean`
  - Matches Maven's behavior where package goal outputs to target/

* **Testing**:
  - Created PasBuild.Test.Package test program
  - Tested with all file combinations (no LICENSE/README, LICENSE only, both)
  - Verified archive structure with unzip
  - Confirmed clean removes archive
  - Zero memory leaks (zipper unit handles cleanup)

**Example Output:**

```bash
$ ./target/PasBuild package
[INFO] PasBuild 1.0.0

[INFO] Executing goal: clean
[INFO] Cleaning project...
[INFO] Deleting: /data/devel/opensource/pasbuild/target
[INFO] Clean complete

[INFO] Executing goal: compile
[INFO] Compiling project...
[INFO] Build command: fpc -Mobjfpc -O1 src/main/pascal/PasBuild.pas -FEtarget ...
Free Pascal Compiler version 3.2.2+dfsg-32 [2024/01/05] for x86_64
...
[INFO] Build successful

[INFO] Executing goal: package
[INFO] Creating release package...
[INFO] Adding to archive: target/pasbuild
[INFO] Adding to archive: LICENSE
[INFO] Adding to archive: README.md
[INFO] Created archive: target/pasbuild-1.0.0.zip
[INFO] Package created successfully: target/pasbuild-1.0.0.zip
```

**Archive Structure:**

```bash
$ unzip -l target/pasbuild-1.0.0.zip
Archive:  target/pasbuild-1.0.0.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
  1289336  2025-12-06 15:35   pasbuild
       28  2025-12-06 15:24   LICENSE
       23  2025-12-06 15:26   README.md
---------                     -------
  1289387                     3 files
```

---


== Phase 3: Template Generation (init Goal) ‚úÖ

**Status:** COMPLETED 2025-12-06

**File:** `src/main/pascal/PasBuild.Command.Init.pas`

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Implement `TInitCommand.Execute`
|Main entry point with interactive prompts

|‚úÖ
|Check if `project.xml` already exists
|Error: "Project already initialized"

|‚úÖ
|Prompt user for project name
|Default: current directory name via GetCurrentDir

|‚úÖ
|Prompt user for version
|Default: `1.0.0`

|‚úÖ
|Prompt user for author
|Default: $USER or $USERNAME environment variable

|‚úÖ
|Prompt user for license
|Options: MIT, BSD-3-Clause, GPL-3.0, Apache-2.0, Proprietary

|‚úÖ
|Create `src/main/pascal/` directories
|Uses `ForceDirectories` with cross-platform paths

|‚úÖ
|Generate `project.xml` from template
|Dynamic generation with user input

|‚úÖ
|Generate `Main.pas` Hello World program
|Template includes {$mode objfpc}{$H+}

|‚úÖ
|Generate LICENSE file from SPDX templates
|MIT, BSD-3-Clause, and Proprietary included

|‚úÖ
|Log success message with next steps
|Shows compile command and executable path

|‚úÖ
|Return exit code 0 on success
|Proper error codes on failure
|===

**Deliverable:** Functional `pasbuild init` command

**Implementation Notes:**

* **Interactive Prompts** with defaults:
  - Project name: Defaults to current directory name
  - Version: Defaults to "1.0.0"
  - Author: Reads from $USER or $USERNAME environment variable
  - License: Defaults to "MIT"

* **Generated Files**:
  - `project.xml`: Complete project configuration
  - `src/main/pascal/Main.pas`: Hello World template
  - `LICENSE`: Full license text from SPDX templates

* **SPDX License Templates**:
  - **MIT**: Full MIT license text with current year
  - **BSD-3-Clause**: Complete BSD 3-Clause license
  - **Proprietary**: Simple proprietary notice
  - **GPL-3.0/Apache-2.0**: Placeholder (user replaces with full text)

* **Main Program Integration**:
  - Skip config loading for init goal (project.xml doesn't exist yet)
  - Skip config validation for init goal
  - Create empty TProjectConfig for init command

* **User Experience**:
  - Clear prompts with visible defaults
  - Press ENTER to accept defaults
  - Helpful "Next steps" message after initialization
  - Shows exact compile and run commands

**Example Usage:**

```bash
$ mkdir MyNewApp
$ cd MyNewApp
$ pasbuild init
[INFO] Initializing new PasBuild project...

Project name [MyNewApp]:
Version [1.0.0]:
Author [graemeg]: John Doe
License (MIT/BSD-3-Clause/GPL-3.0/Apache-2.0/Proprietary) [MIT]:

[INFO] Creating project structure...
[INFO] Created directory: src/main/pascal
[INFO] Created: project.xml
[INFO] Created: src/main/pascal/Main.pas
[INFO] Created: LICENSE

[INFO] Project initialized successfully!

[INFO] Next steps:
[INFO]   1. Edit src/main/pascal/Main.pas
[INFO]   2. Run: pasbuild compile
[INFO]   3. Run: ./target/mynewapp

$ pasbuild compile
[INFO] Compiling project...
[INFO] Build successful

$ ./target/mynewapp
Hello from MyNewApp!
Build tool: PasBuild
```

---


== Phase 4: Goal Dependencies & Integration

=== 4.1 Goal Dependency System ‚úÖ

**Status:** COMPLETED 2025-12-06 (via Command Pattern)

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Implement goal dependency resolver
|TCommandExecutor executes dependencies recursively

|‚úÖ
|Add dependency tracking to prevent duplicate execution
|Executed commands tracked in TStringList

|‚úÖ
|Implement fail-fast on dependency failure
|Exit immediately if dependency returns non-zero

|‚úÖ
|Wire `package` goal dependencies
|TPackageCommand.GetDependencies returns clean ‚Üí compile
|===

**Deliverable:** Maven-like goal lifecycle

**Implementation Notes:**

* **Command Pattern Implementation** (Phase 2.1):
  - `TBuildCommand` base class with `GetDependencies` virtual method
  - `TCommandExecutor` automatically resolves and executes dependencies
  - Dependency chain executed depth-first before main command

* **Duplicate Prevention**:
  - Executor maintains list of executed command names
  - Command identified by `GetName` method
  - Skips execution if command already run: `"[INFO] Goal '<name>' already executed, skipping"`

* **Fail-Fast Behavior**:
  - If dependency returns exit code ‚â† 0, execution stops
  - Error logged: `"[ERROR] Goal failed: <name>"`
  - No subsequent goals execute

* **Package Goal Dependencies**:
  ```pascal
  function TPackageCommand.GetDependencies: TBuildCommandList;
  begin
    Result := TBuildCommandList.Create(False);
    Result.Add(TCleanCommand.Create(Config, ProfileId));
    Result.Add(TCompileCommand.Create(Config, ProfileId));
  end;
  ```

* **Execution Flow** for `pasbuild package`:
  1. Execute clean (dependency)
  2. Execute compile (dependency)
  3. Execute package (main goal)

---

=== 4.2 Integration & Polish

[cols="1,3,1"]
|===
|Status |Task |Notes

|‚úÖ
|Wire all goals into main program
|All 4 goals integrated: clean, compile, package, init

|‚úÖ
|Implement `--help` output
|TArgumentParser.ShowHelp with all goals

|‚úÖ
|Implement `--version` output
|Shows PasBuild version and FPC detection info

|‚úÖ
|Test all goals on Linux
|All goals tested on Linux x86_64

|‚¨ú
|Test all goals on Windows
|Cross-platform verification needed

|‚úÖ
|Create PasBuild's own `project.xml`
|Created in Phase 0

|‚úÖ
|Build PasBuild using PasBuild
|Self-hosting achieved in Phase 2.2.1

|‚¨ú
|Write user documentation (`README.adoc`)
|Getting started guide needed

|‚¨ú
|Create example project in `examples/`
|Demonstration project needed
|===

**Deliverable:** Production-ready PasBuild 1.0.0

**Completed Items:**

* **Main Program Integration** (Phase 2.2.1):
  - All goals wired into `src/main/pascal/PasBuild.pas`
  - Proper error handling and exit code propagation
  - Special handling for init goal (skips config loading)

* **Help System** (Phase 1.3):
  - `--help` / `-h` flag implemented
  - Shows usage: `pasbuild <goal> [options]`
  - Lists all available goals: clean, compile, package, init
  - Documents `-p/--profile` option

* **Version Command** (Phase 1.3):
  - `--version` / `-v` flag implemented
  - Shows PasBuild version from PASBUILD_VERSION constant
  - Includes FPC version detection recommendation

* **Linux Testing**:
  - All goals tested on Linux x86_64
  - FPC 3.2.2 compatibility verified
  - Memory leak testing with -gh flag (zero leaks)
  - End-to-end workflows validated

* **Self-Hosting** (Phase 2.2.1):
  - PasBuild has its own `project.xml`
  - Can compile itself: `pasbuild compile`
  - Can package itself: `pasbuild package`
  - Bootstrap process documented in `BOOTSTRAP.txt`

**Remaining Items:**

* **Windows Testing**: Need to verify all goals on Windows
* **User Documentation**: README.adoc or README.md needed
* **Example Projects**: Demonstration projects in examples/ directory


== Phase 5: Future Enhancements

**Status:** ‚è∏Ô∏è Deferred until post-MVP

[cols="1,3,1"]
|===
|Status |Task |Priority

|‚è∏Ô∏è
|Implement test goal (`pasbuild test`)
|High

|‚è∏Ô∏è
|Implement resource copying
|Medium

|‚è∏Ô∏è
|Implement version injection (`-dVERSION`)
|Low

|‚è∏Ô∏è
|Implement source code packaging goal
|Low

|‚úÖ
|Add `<compilerOptions>` support per-profile
|Implemented in MVP (profiles support this)

|‚è∏Ô∏è
|Add global `<build><compilerOptions>` support
|Low (profile-level sufficient for MVP)

|‚è∏Ô∏è
|Support multiple profile activation
|Low

|‚è∏Ô∏è
|Create XSD schema for `project.xml`
|Medium

|‚è∏Ô∏è
|Add `<build><compilerPath>` override
|Low
|===


== Testing Strategy

=== Manual Testing Checklist

**Per Phase:** Test each goal individually before proceeding

**Phase 2.1 (Clean):**

- [ ] `pasbuild clean` deletes `target/` directory
- [ ] Running clean when `target/` doesn't exist doesn't error
- [ ] Clean with custom `<outputDirectory>` works

**Phase 2.2 (Compile):**

- [ ] `pasbuild compile` builds Hello World successfully
- [ ] Executable runs and prints expected output
- [ ] `pasbuild compile -p debug` activates profile defines
- [ ] Invalid profile ID shows warning
- [ ] Missing `src/main/pascal/` shows clear error
- [ ] Missing FPC in PATH shows clear error
- [ ] Subdirectories generate correct `-Fu` flags

**Phase 2.3 (Package):**

- [ ] `pasbuild package` creates zip archive
- [ ] Archive contains executable + LICENSE
- [ ] Archive name matches `<name>-<version>.zip`
- [ ] Intermediate files (*.o, *.ppu) excluded

**Phase 3 (Init):**

- [ ] `pasbuild init` creates directory structure
- [ ] Generated `project.xml` is valid
- [ ] Generated `Main.pas` compiles
- [ ] `pasbuild init` in existing project shows error
- [ ] Selected license file is generated correctly (BSD-3-Clause support)
- [ ] Profile compiler options override base options correctly

**Phase 4 (Integration):**

- [ ] Goal dependencies execute in correct order
- [ ] `pasbuild package` runs: clean ‚Üí compile ‚Üí package
- [ ] Failed dependency stops execution (fail-fast)
- [ ] PasBuild builds itself using `pasbuild compile`
- [ ] PasBuild packages itself using `pasbuild package`
- [ ] `--help` displays all goals
- [ ] `--version` shows correct versions

=== Automated Testing (Future)

- [ ] Unit tests for ConfigLoader (XML parsing)
- [ ] Unit tests for CLI argument parsing
- [ ] Integration tests for each goal
- [ ] Cross-platform CI pipeline (GitHub Actions)


== Known Issues / Blockers

**None currently.**

_(Update this section as issues arise during implementation)_


== Development Notes

=== Coding Standards

* **Unit naming:** `PasBuild.<Module>.pas`
* **Mode directive:** `{$mode objfpc}{$H+}`
* **String type:** Always use `string` (AnsiString with `{$H+}`)
* **Indentation:** 2 spaces (no tabs)
* **Naming conventions:**
  - Types: `TPascalCase`
  - Variables: `PascalCase`
  - Constants: `UPPER_SNAKE_CASE`
  - Functions/procedures: `PascalCase`

=== Build Commands (Self-Hosting)

**Initial build (manual):**
[source,bash]
----
fpc -Mobjfpc -O1 -FEtarget -FUtarget/units src/main/pascal/PasBuild.lpr
----

**After Phase 4 (self-hosted):**
[source,bash]
----
./target/pasbuild compile
----

=== Git Workflow

**Branches:**

* `master` - Stable releases only
* `develop` - Integration branch
* `feature/phase-X` - Per-phase development

**Commit Messages:**

* Format: `[Phase X.Y] Brief description`
* Example: `[Phase 1.2] Implement XML parsing for build section`

=== Release Checklist

**Before tagging 1.0.0:**

- [ ] All Phase 4 tasks completed
- [ ] Manual testing checklist passed on Linux
- [ ] Manual testing checklist passed on Windows
- [ ] Documentation complete (`README.adoc`, `design.adoc`)
- [ ] Self-hosting test passed
- [ ] Example project works
- [ ] CHANGELOG.adoc created
